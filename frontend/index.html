<!doctype html>
<html lang="en">
  <head>
    <script src="https://tigsaw.com/api/delivery/73T2CMNQ/common"></script>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/vite.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pdf Upload</title>
  </head>
  <body className="dark">
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
    <script>
      (() => {
        let html = `<p class="my-html">hi</p>`;
        let css = `
                .my-html {
                    color: red;
                }    
        `;
        let js = `console.log('Hello from the inserted script!');`;
        const insertCSS = (cssContent) => {
          const style = document.createElement("style");
          style.type = "text/css";

          // Add the CSS content
          style.styleSheet
            ? (style.styleSheet.cssText = cssContent) // For IE
            : style.appendChild(document.createTextNode(cssContent)); // For modern browsers

          // Append the <style> element to the <head>
          document.head.appendChild(style);
        };

        // Example CSS to insert
        const cssRules = `
        div#tigsaw-hover-drawer {
            background: #FFF;
            box-shadow: 1px 1px 12px 0px #00000057;
            padding: 3px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            border-radius: 8px;
            z-index: 9999;
        }

        div#tigsaw-hover-drawer button {
            background: var(--Bg-2, linear-gradient(90deg, #EA0188 0%, #E18700 61.12%));
            border: 0;
            padding: 8px 15px;
            color: #FFF;
            font-family: sans-serif;
            font-size: 15px;
            font-style: normal;
            font-weight: 400;
            line-height: normal;
            width: 100%;
            border-radius: 4px;
        }
        .tigsaw-hover-highlight {
                outline: 2px dashed #EA0188;
        }   
        #tigsaw-bottom-drawer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: -webkit-fill-available;
            min-height: 70px;
            background: var(--Bg-2, linear-gradient(90deg, #EA0188 0%, #E18700 61.12%));
            z-index: 9999999999999;
            padding: 20px;
        }


        div#tigsaw-bottom-drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        div#tigsaw-bottom-drawer-header > button {
            border: 0;
            background: white;
            padding: 5px 10px;
            cursor: pointer;
        }
            div#tigsaw-bottom-drawer.minimized {
            overflow: hidden;
            right: 7px;
            left: unset;
            background: unset;
            width: max-content;
            padding: 0;
            left: unset;
            bottom: 7px;
            min-height: unset;
        }

            div#tigsaw-bottom-drawer-header div {
                color: white;
                font-size: 21px;
            }
              

        div#tigsaw-bottom-drawer.minimized ul {
            display: none !important;
        }

        div#tigsaw-bottom-drawer.minimized div#tigsaw-bottom-drawer-header > div {
            display: none;
        }

        div#tigsaw-bottom-drawer.minimized div#tigsaw-bottom-drawer-header > button {
            background: var(--Bg-2, linear-gradient(90deg, #EA0188 0%, #E18700 61.12%));
            height: 50px;
            width: 50px;
            border-radius: 8px;
        }

        div#tigsaw-bottom-drawer.minimized div#tigsaw-bottom-drawer-header > button svg {
            max-height: 30px;
        }
            div#tigsaw-bottom-drawer > ul {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            row-gap: 7px;
            margin-top: 5px;
            border-top: 1px solid #ffffff14;
            padding-top: 10px;
        }

        div#tigsaw-bottom-drawer > ul li {
            display: flex;
            justify-content: space-between;
        }

        div#tigsaw-bottom-drawer > ul li {
            font-size: small;
            color: white;
        }

        div#tigsaw-bottom-drawer > ul li button {
            border: 0;
            font-size: 10px;
        }
        div#tigsaw-bottom-drawer > ul li button {
            cursor: pointer;
        }

        div#tigsaw-bottom-drawer > ul li button:hover {
            opacity: 0.9;
        }

        div#tigsaw-bottom-drawer-header > button:hover {
            opacity: 0.9;
        }
        div#tigsaw-hover-drawer button {
            cursor: pointer;
        }
        div#tigsaw-bottom-drawer-publish {
            position: absolute;
            right: 20px;
            font-size: 14px !important;
            background: #4CAF50;
            display: flex;
            align-items: center;
            font-weight: bold;
            color: #ffffff !important;
            cursor: pointer;
            height: 25px;
            padding: 0 20px;
            font-family: sans-serif;
        }

        div#tigsaw-bottom-drawer-header > button {
            margin-right: 100px;
        }
        div#tigsaw-bottom-drawer > ul li button {
            padding: 3px 10px;
        }

        div#tigsaw-bottom-drawer-header div {
            font-family: sans-serif;
        }
        div#tigsaw-bottom-drawer.minimized button {
            margin: 0;
        }
    `;

        // Insert the CSS
        insertCSS(cssRules);

        // Global state to store actions
        window.tigsawActionList = []; // Array to store actions { selector, actionType }

        const renderDrawer = () => {
          let drawer = document.getElementById("tigsaw-bottom-drawer");
          if (!drawer) {
            // Create the drawer container
            drawer = document.createElement("div");
            drawer.id = "tigsaw-bottom-drawer";

            // Add the drawer to the body
            document.body.appendChild(drawer);
          }

          drawer.innerHTML = ""; // Clear existing content

          // Header with logo and minimize button
          const header = document.createElement("div");
          header.id = "tigsaw-bottom-drawer-header";
          const publish = document.createElement("div");
          publish.id = "tigsaw-bottom-drawer-publish";
          publish.textContent = "Publish";

          const logo = document.createElement("div");
          logo.textContent = "Tigsaw Action Panel";

          const minimizeButton = document.createElement("button");
          minimizeButton.textContent = "Minimize";

          minimizeButton.addEventListener("click", () => {
            if (!drawer.classList.contains("minimized")) {
              drawer.classList.add("minimized");
              minimizeButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="21" height="39" viewBox="0 0 21 39" fill="none">
<path d="M4.34993 19.775H0.169922V13.895C0.369922 13.885 0.589927 13.855 0.799927 13.855C6.99993 13.855 13.1899 13.855 19.3899 13.845C19.8899 13.845 20.0699 13.965 20.0599 14.495C20.0299 16.055 20.0499 17.615 20.0499 19.175C20.0499 19.355 20.0299 19.535 20.0099 19.765H12.6899C12.6899 20.005 12.6899 20.195 12.6899 20.395C12.6899 23.495 12.6899 26.595 12.6899 29.695C12.6899 30.105 12.7299 30.515 12.8199 30.915C13.0699 32.035 13.7999 32.705 14.9099 32.905C16.3699 33.165 17.7699 32.995 19.0699 32.245C19.2099 32.165 19.3499 32.095 19.5399 31.985C19.8099 33.595 20.0599 35.145 20.3299 36.695C20.3999 37.065 20.1899 37.205 19.9299 37.355C17.8699 38.505 15.6399 38.945 13.3099 38.925C11.6799 38.905 10.0799 38.745 8.54993 38.135C6.07993 37.145 4.76992 35.255 4.47992 32.665C4.32992 31.345 4.34992 30.005 4.33992 28.675C4.31992 25.965 4.33992 23.255 4.33992 20.545C4.33992 20.325 4.33992 20.095 4.33992 19.785L4.34993 19.775Z" fill="white"/>
<path d="M4.47986 8.09503C4.47986 7.39503 4.46986 6.69503 4.47986 6.00503C4.52986 3.42503 6.48987 1.17503 8.92987 0.895027C11.6599 0.575027 14.0999 2.18503 14.7899 4.77503C15.6799 8.06503 13.1499 11.355 9.73987 11.365C8.23987 11.365 6.73986 11.345 5.24986 11.375C4.66986 11.385 4.43986 11.235 4.46986 10.625C4.50986 9.78503 4.47986 8.94503 4.47986 8.10503V8.09503Z" fill="white"/>
</svg>`;
            } else {
              drawer.classList.remove("minimized");
              minimizeButton.textContent = "Minimize";
            }
          });

          header.appendChild(logo);
          header.appendChild(minimizeButton);
          header.appendChild(publish);
          drawer.appendChild(header);

          // Action list
          const actionList = document.createElement("ul");
          actionList.style.listStyleType = "none";

          window.tigsawActionList.forEach((action, index) => {
            const listItem = document.createElement("li");

            const actionText = document.createElement("span");
            actionText.textContent = `${action.actionType.toUpperCase()} - ${
              action.selector
            }`;

            const removeButton = document.createElement("button");
            removeButton.textContent = "Remove";

            removeButton.addEventListener("click", () => {
              // Get the action being removed
              const action = window.tigsawActionList[index];

              // Remove the actual inserted element if it exists
              if (action.insertedElement && action.insertedElement.parentNode) {
                action.insertedElement.parentNode.removeChild(
                  action.insertedElement
                );
              }

              // Remove action from the global state
              window.tigsawActionList.splice(index, 1);
              console.log("Updated Tigsaw Actions:", window.tigsawActionList);

              renderDrawer();
            });

            listItem.appendChild(actionText);
            listItem.appendChild(removeButton);
            actionList.appendChild(listItem);
          });

          drawer.appendChild(actionList);
        };

        // Function to add an action to the list
        window.addTigsawAction = (selector, actionType, insertedElement) => {
          if (!selector || !actionType) {
            console.error("Both selector and actionType are required.");
            return;
          }

          window.tigsawActionList.push({
            selector,
            actionType,
            insertedElement,
          });
          console.log("Updated Tigsaw Actions:", window.tigsawActionList);

          renderDrawer();
        };

        // Initial render of the drawer
        renderDrawer();

        const insertContentDirectly = (selector, html, css, js, action) => {
          // Validate the selector and find the target element
          const targetElement = document.querySelector(selector);
          if (!targetElement) {
            console.error(
              "Element not found for the given selector:",
              selector
            );
            return;
          }

          // Parse HTML and insert it
          const insertHTML = () => {
            const tempDiv = document.createElement("div");
            tempDiv.innerHTML = html.trim();

            let insertedElement;
            if (action === "before") {
              insertedElement = tempDiv.firstChild;
              targetElement.parentNode.insertBefore(
                insertedElement,
                targetElement
              );
            } else if (action === "after") {
              insertedElement = tempDiv.firstChild;
              targetElement.parentNode.insertBefore(
                insertedElement,
                targetElement.nextSibling
              );
            } else {
              console.error("Invalid action. Use 'before' or 'after'.");
              return null;
            }
            return insertedElement; // Return the reference to inserted element
          };

          // Insert the HTML content
          const insertedElement = html ? insertHTML() : null;

          // Add CSS content dynamically to <head>
          if (css) {
            const style = document.createElement("style");
            style.type = "text/css";

            if (style.styleSheet) {
              // For IE
              style.styleSheet.cssText = css;
            } else {
              // For modern browsers
              style.appendChild(document.createTextNode(css));
            }

            document.head.appendChild(style);
          }

          // Add JavaScript content dynamically after the inserted HTML
          if (js) {
            const script = document.createElement("script");
            script.type = "text/javascript";
            script.textContent = js;
            document.body.appendChild(script);
          }
          return insertedElement;
        };

        // tree selector
        const getTreeSelector = (element) => {
          if (!element) return null;

          const getElementIndex = (el) => {
            // Get the position of the element among its siblings of the same tag
            const siblings = Array.from(el.parentNode.children).filter(
              (sibling) => sibling.tagName === el.tagName
            );
            return siblings.indexOf(el) + 1; // Add 1 to make it 1-based index
          };

          const getElementPath = (el) => {
            let path = [];
            while (el && el.nodeType === Node.ELEMENT_NODE) {
              const tagName = el.tagName.toLowerCase();

              // Add position index using nth-of-type
              const index = el.parentNode
                ? `:nth-of-type(${getElementIndex(el)})`
                : "";

              // Construct selector for the element
              path.unshift(`${tagName}${index}`);

              // Traverse up the DOM tree
              el = el.parentNode;
            }
            return path.join(" > ");
          };

          return getElementPath(element);
        };
        const HoverAndDrawer = (() => {
          let drawerOpen = false; // Track if the drawer is open

          // Add hover effect
          const addHoverEffect = () => {
            document.body.addEventListener("mouseover", (event) => {
              const element = event.target;

              // Check if the current element is the drawer or inside the drawer
              const isInsideDrawer =
  element.id?.includes("tigsaw-hover-drawer") ||
  element.closest("#tigsaw-hover-drawer") ||
  element.id?.includes("tigsaw-bottom-drawer") ||
  element.closest("#tigsaw-bottom-drawer");

              // Exit early if the condition is true (hovering over or inside the drawer)
              if (isInsideDrawer) {
                return;
              }

              // Add hover highlight to the element
              element.classList.add("tigsaw-hover-highlight");
            });

            document.body.addEventListener("mouseout", (event) => {
              const element = event.target;

              // Remove the hover highlight when the mouse leaves the element
              element.classList.remove("tigsaw-hover-highlight");
            });
          };

          // Function to close the drawer
          const closeDrawer = () => {
            const existingDrawer = document.getElementById(
              "tigsaw-hover-drawer"
            );
            if (existingDrawer) existingDrawer.remove();
            drawerOpen = false; // Mark drawer as closed
          };

          // Create and open drawer at the cursor position
          const createDrawer = (element, mouseX, mouseY) => {
            // If the drawer is already open and the click is inside the drawer, do nothing
            const existingDrawer = document.getElementById(
              "tigsaw-hover-drawer"
            );
            if (drawerOpen && existingDrawer?.contains(element)) {
              return;
            }

            // Remove existing drawer if any
            closeDrawer();

            // Create drawer
            const drawer = document.createElement("div");
            drawer.id = "tigsaw-hover-drawer";
            drawer.style.position = "fixed";
            drawer.style.left = `${mouseX}px`;
            drawer.style.top = `${mouseY}px`;

            // Adjust for screen boundaries
            const screenWidth = window.innerWidth;
            const screenHeight = window.innerHeight;
            const drawerWidth = 200; // Estimated drawer width
            const drawerHeight = 80; // Estimated drawer height

            if (mouseX + drawerWidth > screenWidth) {
              drawer.style.left = `${screenWidth - drawerWidth - 10}px`; // Shift left
            }
            if (mouseY + drawerHeight > screenHeight) {
              drawer.style.top = `${screenHeight - drawerHeight - 10}px`; // Shift up
            }

            // Add options
            const insertBefore = document.createElement("button");
            insertBefore.textContent = "Insert Before";
            insertBefore.style.marginRight = "10px";

            const insertAfter = document.createElement("button");
            insertAfter.textContent = "Insert After";

            // Attach event listeners for options
            insertBefore.addEventListener("click", () => {
              const selector = getTreeSelector(element);
              const insertedElement = insertContentDirectly(
                selector,
                html,
                css,
                js,
                "before"
              );
              // Store both action and element reference
              addTigsawAction(selector, "before", insertedElement);
              closeDrawer();
            });

            insertAfter.addEventListener("click", () => {
              const selector = getTreeSelector(element);
              const insertedElement = insertContentDirectly(
                selector,
                html,
                css,
                js,
                "after"
              );
              // Store both action and element reference
              addTigsawAction(selector, "after", insertedElement);
              closeDrawer();
            });

            // Append buttons to drawer
            drawer.appendChild(insertBefore);
            drawer.appendChild(insertAfter);

            // Append drawer to body
            document.body.appendChild(drawer);
            drawerOpen = true; // Mark drawer as open
          };

          // Get the unique selector of an element
          const getElementSelector = (element) => {
            if (!element) return "";
            const tagName = element.tagName.toLowerCase();
            const id = element.id ? `#${element.id}` : "";
            const classes = element.className
              ? `.${element.className.trim().replace(/\s+/g, ".")}`
              : "";
            return `${tagName}${id}${classes}`;
          };

          // Handle click events
          const handleClick = () => {
            document.body.addEventListener("click", (event) => {
              const element = event.target;
              const { clientX: screenX, clientY: screenY } = event; // Get cursor position

              // Check if the click is inside the drawer
              const isInsideDrawer =
                element.id?.includes("tigsaw-hover-drawer") ||
                element.closest("#tigsaw-hover-drawer");

              if (!isInsideDrawer) {
                // If click is outside the drawer, close it
                closeDrawer();
              } else {
                // If click is inside the drawer, do nothing
                return;
              }

              // Create a new drawer if clicking outside
              createDrawer(element, screenX, screenY);
            });
          };

          // Initialize the module
          const init = () => {
            addHoverEffect();
            handleClick();
          };

          return { init };
        })();

        // Initialize the functionality
        HoverAndDrawer.init();
  
        document.addEventListener("click", (event) => {
            // Check if the clicked element matches the selector
            if (event.target.matches("div#tigsaw-bottom-drawer-publish")) {
                // Convert the array into a JSON string
                const dataString = JSON.stringify(window.tigsawActionList);

                if (dataString) {
                    // Ensure you replace the origin with the actual parent window's origin
                    const parentOrigin = "http://localhost:3000/editor/cm6guwhni000624gsvwxkrxyz"; // e.g., "https://vishalvishwakarma.co.in"

                    // Check if window.opener is available and not closed
                    if (window.opener && !window.opener.closed) {
                        window.opener.postMessage(dataString, parentOrigin);
                        console.log('Data sent to parent window:', dataString);
                    } else {
                        console.error('Parent window is not available.');
                        alert('Parent window is not available.');
                    }
                } else {
                    console.error('No data to send.');
                }
            }
        });

      })();
    </script>
  </body>
</html>
